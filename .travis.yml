dist: trusty
sudo: false
language: php

php:
    - 7.1

sudo: false
cache:
    directories:
        - $HOME/.composer

env:
    global:
        - COMPOSER_NO_INTERACTION=1
        - SYMFONY_DEBUG=true
        - SYMFONY_ENV=test
        - HITTRACKER_SESSION_SECRET=ff3464e484bb524fb4234e893f9cee58
    matrix:
        - HITTRACKER_BUILD_TYPE=hosted
          HITTRACKER_DATABASE_NAME=hittracker
          HITTRACKER_DATABASE_USER=postgres
        - HITTRACKER_BUILD_TYPE=standalone
          HITTRACKER_DATABASE_NAME=hittracker
          HITTRACKER_DATABASE_USER=postgres
        - HITTRACKER_BUILD_TYPE=electron
          HITTRACKER_DATABASE_PATH="var/data/hitttracker.db"

services:
  - postgresql
addons:
    postgresql: '9.6'

install:
    - export PHPRC=$TRAVIS_BUILD_DIR/etc/php/php.ini
    - export PHP_INI_SCAN_DIR=$TRAVIS_BUILD_DIR/etc/php/unix
    - composer install --prefer-dist

before_script:
    - php bin/console doctrine:database:create
    - php bin/console doctrine:migrations:migrate --no-interaction
#    - php bin/console doctrine:fixtures:load --no-interaction
    - php bin/console cache:warmup

script:
    - ./vendor/bin/php-cs-fixer fix --diff --dry-run -v
    - ./vendor/bin/phpstan analyse -l5 src/ -c phpstan.neon
    - ./vendor/bin/phpunit

before_deploy:
    - export SYMFONY_ENV=production
    - composer install --no-dev --prefer-dist --no-scripts
    - composer dump-autoload --optimize --classmap-authoritative
    - if [ ${SYMFONY__BUILD_TYPE} = "electron" ]; then php bin/create_electron_archive.php linux $TRAVIS_TAG; fi

deploy:
    provider: releases
    api_key:
        secure: "LJ1ZwqBmg6GajDkgtFrgkNttfmBObPAAUPnJr8d53mXEA6+ZwZw/fIXOt7BzOQOow2DWMDf+PAqMkmSQLwdjnRB+jGIa4yJHnOQ1BxgyLuiQ5yiFckkHwBt+1HrKGZ54uxaQBej1/wbBi1GrEhz5BNWjAsHotGVMbiJ6dR4uU24="
    file: "*.tar.bz2"
    file_glob: true
    skip_cleanup: true
    on:
        tags: true

branches:
    except:
        - gh-pages
