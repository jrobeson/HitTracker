#!/usr/bin/env ruby
require 'json'
require 'net/http'
require 'optparse'
require 'serialport'

# Noop Logger
class Logger

  def debug(message)
    write message
  end

  def error(message)
    write message
  end

  def info(message)
    write message
  end

  def write(message)
  end
end

class ConsoleLogger < Logger
  def write(message)
    puts message
  end
end

class HitReader
  BAUD_RATE = 9600 # this is required by the device
  # Any of the other button presses are not valid zones
  BUTTON_ZONE_MAP = {
    16 => 1,
    32 => 2,
    64 => 3,
  }

  DEBOUNCE_DELAY = 200

  attr_reader :host_url, :logger

  def initialize(logger)
    @logger = logger
  end

  def setup(device_path, host_url = nil)
    @dongle = init_dongle device_path
    @logger.info "Initialized Port: #{device_path}"
    @host_url = host_url
    if @host_url
      @logger.info "Hit Target Url: #{host_url}"
    end
  end

  def run
    last_debounce_time = 0
    last_hit = {radioId: '', zone: 0, hit_matcher: 0}
    loop do
      IO.select([@dongle])
      button, radio_id = get_message(@dongle, 5)

      # the keyfob includes alternate button states
      # we do not use, so ignore them.
      next unless BUTTON_ZONE_MAP.include? button

      hit = build button, radio_id

      # avoid "hold" presses counting as multiple hits
      next if hit.eql?(last_hit) && !debounced?(last_debounce_time)

      last_debounce_time = millis

      last_hit = hit.clone
      @logger.debug JSON.dump hit

      publish hit
    end
  end

  def debounced?(last_debounce_time)
    (millis - last_debounce_time) > DEBOUNCE_DELAY
  end

  def init_dongle(path)
    SerialPort.new path, BAUD_RATE
  rescue Errno::ENOENT => e
    @logger.error e.message
    exit false
  end

  def get_message(io_dev, size)
    message = ''
    len = message.length
    while len < size
      chunk = io_dev.read(size - len)
      # error checking on chunk value
      message += chunk
      len = message.length
    end
    return message.unpack('CH8')
  end

  def publish(hit)
    return nil unless @host_url

    uri = URI(@host_url)
    hit[:time] = Time.now
    res = Net::HTTP.post_form(uri, hit)
    @logger.debug res.body
  end

  def build(button, radio_id)
    { radioId: radio_id,
      zone: BUTTON_ZONE_MAP[button],
    }
  end

  def millis
    (Time.now.to_f * 1000.0).to_i
  end
end

logger = ConsoleLogger.new
hr = HitReader.new logger
hr.setup ARGV[0], ARGV[1]
hr.run
